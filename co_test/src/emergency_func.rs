use socketcan::CanSocket;
use crate::util::{exp, send};

pub fn emergency_basic(s: &CanSocket) {
    // Disable TPDOs
    send(&s, 0x602, 0x23_00_18_01_82_01_00_C0, 8);
    exp(&s, 0x582, 0x60_00_18_01_00_00_00_00, 8);
    send(&s, 0x602, 0x23_01_18_01_82_02_00_C0, 8);
    exp(&s, 0x582, 0x60_01_18_01_00_00_00_00, 8);

    // Set state to pre-operational and set 0x1800 related.
    send(&s, 0x000, 0x80_02, 2);
    // Write value C0000202h to object 1400h:01h
    send(&s, 0x602, 0x23_00_14_01_02_02_00_C0, 8);
    exp(&s, 0x582, 0x60_00_14_01_00_00_00_00, 8);
    // Write value 0Ah to object 1400h:02h
    send(&s, 0x602, 0x2F_00_14_02_0A_00_00_00, 8);
    exp(&s, 0x582, 0x60_00_14_02_00_00_00_00, 8);
    // Write value 0h to object 1400h:05h
    send(&s, 0x602, 0x2B_00_14_05_00_00_00_00, 8);
    exp(&s, 0x582, 0x60_00_14_05_00_00_00_00, 8);
    // Write value 40000202h to object 1400h:01h, enable the RPDO object
    send(&s, 0x602, 0x23_00_14_01_02_02_00_40, 8);
    exp(&s, 0x582, 0x60_00_14_01_00_00_00_00, 8);

    send(&s, 0x602, 0x40_00_16_00_00_00_00_00, 8);
    exp(&s, 0x582, 0x4F_00_16_00_02_00_00_00, 8);
    send(&s, 0x602, 0x40_00_16_01_00_00_00_00, 8);
    exp(&s, 0x582, 0x43_00_16_01_08_01_00_62, 8);
    send(&s, 0x602, 0x40_00_16_02_00_00_00_00, 8);
    exp(&s, 0x582, 0x43_00_16_02_08_02_00_62, 8);

    send(&s, 0x602, 0x2F_00_62_01_00_00_00_00, 8);
    exp(&s, 0x582, 0x60_00_62_01_00_00_00_00, 8);
    send(&s, 0x602, 0x2F_00_62_02_00_00_00_00, 8);
    exp(&s, 0x582, 0x60_00_62_02_00_00_00_00, 8);

    // Set device to Operational
    send(&s, 0x000, 0x01_02, 2);

    send(&s, 0x202, 0x0A, 1);
    exp(&s, 0x082, 0x10_82_00_02_02_00_00_00, 8);
    exp(&s, 0x082, 0x00_00_00_02_02_00_00_00, 8);

    send(&s, 0x202, 0x0B, 1);
    exp(&s, 0x082, 0x10_82_00_02_02_00_00_00, 8);
    exp(&s, 0x082, 0x00_00_00_02_02_00_00_00, 8);

    send(&s, 0x602, 0x40_03_10_00_00_00_00_00, 8);
    exp(&s, 0x582, 0x4F_03_10_00_02_00_00_00, 8);
    send(&s, 0x602, 0x40_03_10_01_00_00_00_00, 8);
    exp(&s, 0x582, 0x43_03_10_01_10_82_00_00, 8);
    send(&s, 0x602, 0x40_03_10_02_00_00_00_00, 8);
    exp(&s, 0x582, 0x43_03_10_02_10_82_00_00, 8);
    send(&s, 0x602, 0x40_01_10_00_00_00_00_00, 8);
    exp(&s, 0x582, 0x4F_01_10_00_00_00_00_00, 8);
}